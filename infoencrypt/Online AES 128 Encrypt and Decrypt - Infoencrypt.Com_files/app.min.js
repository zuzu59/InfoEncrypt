angular.module("infoencrypt",["ui.bootstrap","ng"]);var BlowfishService;BlowfishService=function(){function a(a){this.log=a}a.prototype.encrypt=function(){throw"Blowfish encryption is disabled";};a.prototype.decrypt=function(a,c){var b,d,e,k;b=a.content.toString(CryptoJS.enc.Base64);e=atob(b);var h,f;b=[];h=0;for(f=e.length;h<f;h++)k=e[h],b.push(k.charCodeAt(0));e="";try{d=new Blowfish(c),e=d.decrypt(b)}catch(l){this.log.error("Decode error",l)}return e};return a}();
angular.module("infoencrypt").service("BlowfishService",["$log",BlowfishService]);var AesService,B64Formatter,CombinedService,UtilsService,init;init=function(){if(!String.prototype.endsWith)return Object.defineProperty(String.prototype,"endsWith",{enumerable:!1,configurable:!1,writable:!1,value:function(a,g){var c;g=g||this.length;g-=a.length;c=this.lastIndexOf(a);return-1!==c&&c===g}})};
UtilsService=function(){function a(){}a.prototype.tag="Encrypted";a.prototype.prefix="To decrypt following message use https://www.infoencrypt.com\n";a.prototype.hex=function(a){var c;c=Math.floor(a/16);a%=16;a+=10>a?48:55;return String.fromCharCode(c+(10>c?48:55))+String.fromCharCode(a)};a.prototype.base64=function(a){var c,b,d,e;e=[];b=0;for(d=a.length;b<d;b++)c=a[b],e.push(String.fromCharCode(c));a=e.join("");return btoa(a)};a.prototype.base64dec=function(a){var c;a=atob(a);var b,d,e;e=[];b=0;
for(d=a.length;b<d;b++)c=a[b],e.push(c.charCodeAt(0));return e};a.prototype.utf2bytes=function(a){var c,b,d,e,k,h;a=a||"";a=a.replace(/\r\n/g,"\n");b=[];c=function(a){if(128>a)return b.push(a);127<a&&2048>a?b.push(a>>6|192):(b.push(a>>12|224),b.push(a>>6&63|128));return b.push(a&63|128)};e=function(b){b=a.charCodeAt(b);return c(b)};d=k=0;for(h=a.length;0<=h?k<=h:k>=h;d=0<=h?++k:--k)e(d);return b};a.prototype.clean=function(a){var c;a=a||"";(c=/<Encrypted>([^]+)<\/Encrypted>/gmi.exec(a))&&(a=c[1]);
return a.replace(/\s+/g,"")};a.prototype.wrap=function(a){a=this.asLines(a);return""+this.prefix+"\x3c"+this.tag+"\x3e\n"+a+"\n\x3c/"+this.tag+"\x3e"};a.prototype.asLines=function(a){var c;for(c=[];80<a.length;)c.push(a.substr(0,80)),a=a.substr(80);c.push(a);return c.join("\n")};return a}();
B64Formatter=function(){function a(){}a.prototype.formatName="infoencrypt.com,AES,128b";a.prototype.hmac=function(a){return CryptoJS.HmacMD5(a,this.formatName)};a.prototype.stringify=function(a){a=a.iv.concat(a.ciphertext);a=this.hmac(a).concat(a);return a.toString(CryptoJS.enc.Base64)};a.prototype.parse=function(a){var c,b,d;if(9>a.words.length)return{hmacConfimed:!1};b=CryptoJS.lib.WordArray.create(a.words.splice(0,4));a=CryptoJS.lib.WordArray.create(a.words,a.sigBytes-16);c=this.hmac(a);d=a.words.splice(0,
4);a=CryptoJS.lib.WordArray.create(a.words,a.sigBytes-16);d=CryptoJS.lib.WordArray.create(d);return CryptoJS.lib.CipherParams.create({iv:d,ciphertext:a,hmac:c,hmacConfimed:c.toString(CryptoJS.enc.Hex)===b.toString(CryptoJS.enc.Hex)})};return a}();
AesService=function(a,g,c){this.aesTrailer="\n-- www.infoencrypt.com AES 128bit";this.salt=CryptoJS.MD5("www.infoencrypt.com");this.key=function(a){a=CryptoJS.MD5(a).toString(CryptoJS.enc.Hex);return CryptoJS.PBKDF2(a,this.salt,{keySize:4,iterations:1E3})};this.aesOpts=function(){return{mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7,format:new B64Formatter,keySize:4}};this.encrypt=function(b,d){var e,k=this;e=g.defer();c(function(){var c,f;try{return c=angular.extend(k.aesOpts(),{iv:CryptoJS.lib.WordArray.random(16)}),
f=CryptoJS.AES.encrypt(b,k.key(d),c),e.resolve(f.toString())}catch(l){return a.error("Cannot encrypt",l),e.reject(l.message)}},100);return e.promise};this.decrypt=function(b,d){var e,k,h=this;k=g.defer();e="invalid input";c(function(){var c,l,n;try{if(l=h.aesOpts(),c=l.format.parse(b.content),c.hmacConfimed||(a.error("Hmac not confirmed"),k.reject({message:"Hmac not confirmed",reason:"notaes"})),l.iv=c.iv,n=CryptoJS.AES.decrypt(c,h.key(d),l),e=n.toString(CryptoJS.enc.Utf8),"string"!==typeof e||0===
e.length)a.error("empty result"),k.reject({message:"Invalid input or password",reason:"invalid"});else return e.endsWith(h.aesTrailer)&&(e=e.substr(0,e.length-h.aesTrailer.length)),k.resolve(e)}catch(g){return a.error("invalid input",g.message),k.reject({message:g.message,reason:"invalid"})}},100);return k.promise};return this};
CombinedService=function(a,g,c,b,d,e){this.encrypt=function(k,h){var f;f=d.defer();e(function(){k=k||"";h=h||"";return 0===k.length?f.reject("Please enter original text"):0===h.length?f.reject("Please enter password"):a.encrypt(k,h).then(function(a){return null===a?(c.error("Null data"),f.reject("Encryption error")):f.resolve(b.format({content:a}))},function(a){return f.reject(a)})},100);return f.promise};this.decrypt=function(c,h){var f,l;c=c||"";h=h||"";if(0===c.length)return l=d.defer(),e(function(){return l.reject("Cannot decrypt from empty input. Please enter an encrypted message")},
100),l.promise;f=b.parse(c);return"AES-128,CBC,PKCS5 Padding"===f.encryption?a.decrypt(f,h):this.decryptOld(f,h)};this.decryptOld=function(b,e){var f,l;f=d.defer();l=angular.copy(b);a.decrypt(b,e).then(function(a){return f.resolve(a)},function(a){return"notaes"===a.reason?(c.warn("Not AES. Try old type of encryption"),a=g.decrypt(l,e),"string"===typeof a&&0<a.length?f.resolve(a):f.reject("Invalid input")):f.reject("Corrupted input or wrong password")});return f.promise};return this};init();
angular.module("infoencrypt").service("UtilsService",UtilsService).service("AesService",["$log","$q","$timeout",AesService]).service("CombinedService",["AesService","BlowfishService","$log","FormatService","$q","$timeout",CombinedService]);var ErrorDlgCtrl,app;ErrorDlgCtrl=function(){return function(a,g,c,b,d){a.title=b;a.message=d;g.info("show error",b,d);a.hide=function(){return c.dismiss("cancel")}}}();app=angular.module("infoencrypt");
app.controller("ErrorDlgCtrl",["$scope","$log","$modalInstance","title","message",ErrorDlgCtrl]);var FormatService;
FormatService=function(a){var g;g=/^([\w\-]+)\s*:\s*(.+)$/;this.format=function(a){var b;a.encryption=a.encryption||"AES-128,CBC,PKCS5 Padding";a.key=a.key||"MD5,PBKDF2 HmacSHA1";a.url=a.url||"https://www.infoencrypt.com";b=[];b.push("-----BEGIN INFOENCRYPT.COM MESSAGE-----");b.push("Encryption-Info: "+a.encryption);b.push("Key-Info: "+a.key);b.push("Decrypt-URL: "+a.url);b.push("");b.push(this.para(this.asString(a.content),76));b.push("-----END INFOENCRYPT.COM MESSAGE-----");return b.join("\r\n")};
this.asString=function(c){if("string"===typeof c)return c;if("object"===typeof c&&"function"===typeof c.toString)return c.toString(CryptoJS.enc.Base64);a.warn("invalid input",c);return""};this.para=function(a,b){var d;if(!("string"===typeof a&&0<a.length&&0<b))return"";for(d=[];0<a.length;)a.length<b?(d.push(a),a=""):(d.push(a.slice(0,b)),a=a.slice(b));return d.join("\r\n")};this.parse=function(c){var b;b={encryption:"Unknown",key:"Unknown"};c=(c||"").trim();if(this.tryOldWrap(c,b))return a.debug("Use old wrapping"),
b;if(this.tryPem(c,b))return a.debug("use pem-like format"),b;c=c.replace(/[\s\n\r]/g,"");if(this.tryBase64(c,b))return a.debug("plain base64"),b;a.warn("unknown format");return b};this.tryOldWrap=function(a,b){var d;return(d=/<Encrypted>([^]+?)<\/Encrypted>/ig.exec(a))?(d=d[1].replace(/[\s\n\r]/g,""),b.content=CryptoJS.enc.Base64.parse(d),!0):!1};this.tryPem=function(c,b){var d,e,k,h,f,l,n,m,p,q=this;f=c.split("\n");n=e=k=!1;d="";l=function(c){var f,l;c=c.trim();if(k){if(e||(e="-----END INFOENCRYPT.COM MESSAGE-----"===
c),!e){if(n)return d+=c;if(0===c.length)return n=!0;if(f=g.exec(c))return l=f[1],f=f[2],"Encryption-Info"===l?b.encryption=f:"Key-Info"===l?b.key=f:"Decrypt-URL"===l?b.url=f:a.warn("invalid header",c);if(q.isBase64(c))return n=!0,d+=c}}else k="-----BEGIN INFOENCRYPT.COM MESSAGE-----"===c};m=0;for(p=f.length;m<p;m++)h=f[m],l(h);if(!k||!e)return!1;b.content=CryptoJS.enc.Base64.parse(d);return!0};this.tryBase64=function(a,b){return this.isBase64(a)?(b.content=CryptoJS.enc.Base64.parse(a),!0):!1};this.isBase64=
function(a){return/[A-Za-z0-9+/=\s]/g.test(a)};return this};app=angular.module("infoencrypt");app.service("FormatService",["$log",FormatService]);var IndexCtrl;
IndexCtrl=function(){return function(a,g,c,b,d,e){var k,h;console.log("injector",arguments);a.encrypting=!1;a.encrypted=!1;a.message=document.getElementById("message").value;a.haveMessage=!1;a.havePass=!1;a.havePassConfirmed=!1;a.$watch("message",function(b,c){return a.haveMessage="string"===typeof b&&0<b.length});a.$watch("password",function(b,c){a.havePass="string"===typeof b&&0<b.length;return a.havePassConfirmed=a.havePass&&"string"===typeof b&&b===a.password});a.$watch("password2",function(b,
c){return a.havePassConfirmed=a.havePass&&"string"===typeof b&&b===a.password});a.doEncrypt=function(b){var d;a.encrypting=!0;b.preventDefault();d=c.defer();d.promise.then(function(b){a.message=b;return a.encrypting=!1},function(b){a.errorMessage=b;return a.encrypting=!1});return g(function(){var b;b=a.password;if(""===b)return d.reject("Please enter a password");if(b!==a.password2)return d.reject("Please check your encryption password (password confirmation doesn't match with original password)");
a.errorMessage="";return e.encrypt(a.message,b).then(function(a){return d.resolve(a)},function(a){return d.reject(a||"Cannot encrypt input data")})},100)};a.doDecrypt=function(d){var l;d.preventDefault();a.decrypting=!0;a.errorMessage="";l=c.defer();l.promise.then(function(c){b.debug("decrypt result",c);a.message=c;"blowfish"===c.mode&&(a.errorMessage="Provided code doesn't look like an Infoencrypt AES encryption. Most likely it was corrupted or some parts of code were missing.");return a.decrypting=
!1},function(c){b.error("decrypt error",c);a.errorMessage=c;return a.decrypting=!1});return g(function(){var c;c=a.password;""===c&&b.warn("Decrypt using empty password");return e.decrypt(a.message,c).then(function(a){return l.resolve(a)},function(a){a=a||{};a.message=a.message||"Cannot decrypt input data. Make sure you have entered valid code encrypted by Infoencrypt";return l.reject(a)})},100)};h=function(a){return d.open({templateUrl:"linkModalContent.html",controller:"LinkDlgCtrl",backdrop:!0,
resolve:{safeUrl:function(){return a}}})};k=function(a,b){return d.open({templateUrl:"errorModalContent.html",controller:"ErrorDlgCtrl",backdrop:!0,resolve:{message:function(){return b},title:function(){return a}}})};a.showSafeDlg=function(c){c.preventDefault();return d.open({templateUrl:"safeModalContent.html",controller:"SafeCtrl",backdrop:!0,resolve:{msg:function(){return a.message}}}).result.then(function(a){b.warn("Link",a);return h(a)},function(a){b.warn("safe error",a);if("cancel"!==a&&"backdrop click"!==
a)return k("Cannot save","A problem occurred during save.                Please check your internet connection, make sure that you have encrypted message and then try again.                And please note that that server accept only encrypted message, so you need to encrypt your message on this screen, before sending to the server.                ")})}}}();angular.module("infoencrypt").controller("IndexCtrl",["$scope","$timeout","$q","$log","$modal","CombinedService",IndexCtrl]);var LinkDlgCtrl;
LinkDlgCtrl=function(){return function(a,g,c){a.safeUrl=c;a.hide=function(){return g.dismiss("cancel")}}}();app=angular.module("infoencrypt");app.controller("LinkDlgCtrl",["$scope","$modalInstance","safeUrl",LinkDlgCtrl]);var OpenSafeCtrl;
OpenSafeCtrl=function(){return function(a,g,c,b,d,e,k){var h,f;a.decrypted=!1;f=function(a,b){return d.open({templateUrl:"errorModalContent.html",controller:"ErrorDlgCtrl",backdrop:!0,resolve:{message:function(){return b},title:function(){return a}}})};h=function(){return $("#decrypted-success").fadeOut(400,function(){return $("#decrypted-next").fadeIn()})};a.doDecrypt=function(d){var g,m;d.preventDefault();a.decrypting=!0;d=function(b){f("Decrypt error","Cannot decrypt using provided password. Please try again.");
return a.decrypting=!1};m=a.password;g=angular.element(document.querySelector("#encrypted")).html();if(""===m)return d("Please enter a password");g=k.parse(g);c.info("decrypt",g);return e.decrypt(g,m).then(function(c){a.message=c;a.decrypting=!1;a.decrypted=!0;return b(h,2E3)},d)}}}();app=angular.module("infoencrypt");app.controller("OpenSafeCtrl",["$scope","$q","$log","$timeout","$modal","AesService","FormatService",OpenSafeCtrl]);var PressCtrl;
PressCtrl=function(){return function(a,g){a.open=function(a){var b;b="https://www.infoencrypt.com/";"nyt"===a?b="http://www.nytimes.com/2014/07/17/technology/personaltech/ways-to-protect-your-email-after-you-send-it.html?ref\x3dpersonaltech\x26_r\x3d1":"bi"===a?b="http://www.businessinsider.com/how-to-send-encrypted-email-securely-2013-6":"htg"===a?b="http://www.howtogeek.com/135638/the-best-free-ways-to-send-encrypted-email-and-secure-messages/":g.error("Unknown target",a);g.debug("goto",b);return window.location.href=
b}}}();app=angular.module("infoencrypt");app.controller("PressCtrl",["$scope","$log",PressCtrl]);var SafeCtrl;SafeCtrl=function(){return function(a,g,c,b,d){a.hide=function(){return b.dismiss("cancel")};a.send=function(){return c.send(d).then(function(a){return b.close("https://www.infoencrypt.com"+a)},function(a){return b.dismiss(a)})}}}();app=angular.module("infoencrypt");app.controller("SafeCtrl",["$scope","$log","SafeService","$modalInstance","msg",SafeCtrl]);var SafeService;
SafeService=function(){return function(a,g,c){this.send=function(b){var d;d=g.defer();a.post("/safe",{msg:b}).success(function(a,b){return 200===b&&a.success?a.details?d.resolve(a.details.path):d.reject("Server returned an invalid response"):d.reject(a.message)}).error(function(a,b){c.error("failed",a,b);return d.reject((null!=a?a.message:void 0)||"Can't send data to the server. Check your connection")});return d.promise}}}();app=angular.module("infoencrypt");
app.service("SafeService",["$http","$q","$log",SafeService]);